---

layout: post
title:  "Android下玩JNI的新老三种姿势"
date:   2017-05-26 1:05:00
catalog:  true
tags:

   - JNI
   - NDK 
   
   
   
       
   
---

<div id="article_content" class="article_content tracking-ad" data-mod="popu_307" data-dsm="post">

<pre style="font-family:SFMono-Regular,Consolas,&quot;Liberation Mono&quot;,Menlo,Courier,monospace; margin-bottom:16px; line-height:1.45; word-wrap:normal; padding:16px; overflow:auto; background-color:rgb(246,248,250); color:rgb(36,41,46); margin-top:0px!important"><strong><span style="font-size:24px">请尊重原创，转载请注明出处:<a target="_blank" href="http://blog.csdn.net/mabeijianxi/article/details/68525164">http://blog.csdn.net/mabeijianxi/article/details/68525164</a></span></strong>&nbsp;</pre>
<p></p>
<pre style="font-family:SFMono-Regular,Consolas,&quot;Liberation Mono&quot;,Menlo,Courier,monospace; font-size:13.6px; margin-bottom:16px; line-height:1.45; word-wrap:normal; padding:16px; overflow:auto; background-color:rgb(246,248,250); color:rgb(36,41,46); margin-top:0px!important"><code style="font-family:SFMono-Regular,Consolas,&quot;Liberation Mono&quot;,Menlo,Courier,monospace; font-size:13.6px; padding:0px; margin:0px; background:transparent; word-break:normal; border:0px; display:inline; overflow:visible; line-height:inherit; word-wrap:normal">说明：本篇不撸代码，只玩编译,其包含了Android studio 2.2最新的JNI玩法
编译环境：macOS 10.12.3
工具包含：Android Studio 2.2  NDK-r14 
</code></pre>
<p></p>
<p style="margin-top:0px; margin-bottom:16px; color:rgb(36,41,46); font-size:16px">
在<a href="http://lib.csdn.net/base/android" class="replace_word" title="Android知识库" target="_blank" style="color:#df3434; font-weight:bold;">Android</a>下要玩jni首先下载ndk是必须的，可以直接去<a target="_blank" href="https://developer.android.google.cn/ndk/downloads/index.html" style="background-color:transparent; color:rgb(3,102,214)"></a><a target="_blank" href="https://developer.android.google.cn/ndk/downloads/index.html" style="background-color:transparent; color:rgb(3,102,214)">https://developer.android.google.cn/ndk/downloads/index.html</a>下载，当然我们家AS为开发者也提供了便捷<br style="">
<br style="">
<a target="_blank" href="https://github.com/mabeijianxi/pic-trusteeship/blob/master/pic/jni/jni_1.png" style="background-color:transparent; color:rgb(3,102,214)"><img src="https://github.com/mabeijianxi/pic-trusteeship/raw/master/pic/jni/jni_1.png" alt="" style="border-style:none; max-width:100%"></a><br style="">
<br style="">
只需如图勾选然后OK即可，我的版本是r14，值得一提的是&nbsp;<span style="font-weight:600">google ndk-build</span>&nbsp;命令在&nbsp;<span style="font-weight:600">r13</span>&nbsp;后默认使用&nbsp;<span style="font-weight:600">Clang</span>，并将在后续版本中移除&nbsp;<span style="font-weight:600">GCC</span>，其编译速度更快、编译产出更小、出错提示更友好。</p>
<h2 style="margin-top:24px; margin-bottom:16px; line-height:1.25; padding-bottom:0.3em; border-bottom:1px solid rgb(234,236,239); color:rgb(36,41,46)"><a name="t0" target="_blank"></a>
<a target="_blank" id="user-content-一徒手编写androidmk然后ndk-build编译" class="anchor" href="https://github.com/mabeijianxi/pic-trusteeship/blob/master/README.md#一徒手编写androidmk然后ndk-build编译" style="background-color:transparent; color:rgb(3,102,214); float:left; padding-right:4px; margin-left:-20px; line-height:1"></a>一、徒手编写Android.mk然后ndk-build编译：</h2>
<p style="margin-top:0px; margin-bottom:16px; color:rgb(36,41,46); font-size:16px">
这种编译其实是用make工具来玩的，在 <a href="http://lib.csdn.net/base/linux" class="replace_word" title="Linux知识库" target="_blank" style="color:#df3434; font-weight:bold;">Linux</a> 徒手写并编译过c的应该很清楚，通过编写makefile，然后再用make编译已经比不停的用gcc命令逐个编译要爽很多,但是 makefile 的编写还是有点蛋疼。程序员都是化繁为简善解人意的，通过 ndk 工具我们无需自己写 makefile 了，现在你只要安心撸自己关心的代码就行了。<br style="">
<br style="">
1、在main下新建&nbsp;<span style="font-weight:600">jni</span>&nbsp;目录，如图：<br style="">
<br style="">
<a target="_blank" href="https://github.com/mabeijianxi/pic-trusteeship/blob/master/pic/jni/jni_2.png" style="background-color:transparent; color:rgb(3,102,214)"><img src="https://github.com/mabeijianxi/pic-trusteeship/raw/master/pic/jni/jni_2.png" alt="" style="border-style:none; max-width:100%"></a><br style="">
<br style="">
2、再新建一个&nbsp;<span style="font-weight:600">c</span>&nbsp;或者&nbsp;<span style="font-weight:600">c++</span>&nbsp;文件，如图：<br style="">
<br style="">
<a target="_blank" href="https://github.com/mabeijianxi/pic-trusteeship/blob/master/pic/jni/jni_3.png" style="background-color:transparent; color:rgb(3,102,214)"><img src="https://github.com/mabeijianxi/pic-trusteeship/raw/master/pic/jni/jni_3.png" alt="" style="border-style:none; max-width:100%"></a><br style="">
<br style="">
3、在<a href="http://lib.csdn.net/base/javase" class="replace_word" title="Java SE知识库" target="_blank" style="color:#df3434; font-weight:bold;">Java</a>里面声明个&nbsp;<span style="font-weight:600">native</span>&nbsp;方法：<br style="">
</p>
<pre style="font-family:SFMono-Regular,Consolas,&quot;Liberation Mono&quot;,Menlo,Courier,monospace; font-size:13.6px; margin-top:0px; margin-bottom:16px; line-height:1.45; word-wrap:normal; padding:16px; overflow:auto; background-color:rgb(246,248,250); color:rgb(36,41,46)"><code style="font-family:SFMono-Regular,Consolas,&quot;Liberation Mono&quot;,Menlo,Courier,monospace; font-size:13.6px; padding:0px; margin:0px; background:transparent; word-break:normal; border:0px; display:inline; overflow:visible; line-height:inherit; word-wrap:normal">
	    private native String jniTellMeWhy(String hiJni);
</code></pre>
<p style="margin-top:0px; margin-bottom:16px; color:rgb(36,41,46); font-size:16px">
4、copy全类名<br style="">
<br style="">
<a target="_blank" href="https://github.com/mabeijianxi/pic-trusteeship/blob/master/pic/jni/jni_4.png" style="background-color:transparent; color:rgb(3,102,214)"><img src="https://github.com/mabeijianxi/pic-trusteeship/raw/master/pic/jni/jni_4.png" alt="" style="border-style:none; max-width:100%"></a><br style="">
<br style="">
然后去我们新建的那个&nbsp;<span style="font-weight:600">hi_jni.cpp</span>&nbsp;里面去声明一个方法，这里就添加头文件了，直接干。命名规则是死的，粘贴一下把"."换成"&nbsp;<span style="font-weight:600">_</span>&nbsp;"再加上“&nbsp;<span style="font-weight:600">_方法名</span>&nbsp;”,我们是有返回值的且是个&nbsp;<span style="font-weight:600">String</span>&nbsp;的，对应的就是&nbsp;<span style="font-weight:600">jstring</span>&nbsp;，最前面拼上固定的“&nbsp;<span style="font-weight:600">Java_</span>&nbsp;”。我们传入了一个参数，但是规定是每个函数默认都会两个参数，一个是&nbsp;<span style="font-weight:600">JNIEnv</span>&nbsp;指针类型的结构体，一个是调用者对象，比如我们这里就是MainActivity对象，其实玩过&nbsp;<span style="font-weight:600">c++</span>&nbsp;的都知道里面每个函数其实默认也会传入个&nbsp;<span style="font-weight:600">this</span>&nbsp;指针的，不然一个类可以有那么多对象怎么知道是哪个对象调用的？言归正传，还有一个参数就是我们传入的&nbsp;<span style="font-weight:600">String</span>&nbsp;值了。如下：<br style="">
</p>
<pre style="font-family:SFMono-Regular,Consolas,&quot;Liberation Mono&quot;,Menlo,Courier,monospace; font-size:13.6px; margin-top:0px; margin-bottom:16px; line-height:1.45; word-wrap:normal; padding:16px; overflow:auto; background-color:rgb(246,248,250); color:rgb(36,41,46)"><code style="font-family:SFMono-Regular,Consolas,&quot;Liberation Mono&quot;,Menlo,Courier,monospace; font-size:13.6px; padding:0px; margin:0px; background:transparent; word-break:normal; border:0px; display:inline; overflow:visible; line-height:inherit; word-wrap:normal">
</code><p class="p1"><span class="s1"><span style="white-space:pre">	</span>#include &lt;jni.h&gt;</span></p><p class="p1"><span class="s2"><span>	</span></span><span class="s1">#include &lt;stdio.h&gt;</span></p><p class="p1"><span class="s2"><span>	</span></span><span class="s1">#include &lt;stdlib.h&gt;</span></p>
extern "C"
jstring
Java_com_example_jianxi_jnidemo_MainActivity_jniTellMeWhy(JNIEnv *env, jobject obj, jstring str) {
    const char *question = env-&gt;GetStringUTFChars(str, JNI_FALSE);
    char *answer = "fuck,no why!!!";
    char *data = (char *) malloc(strlen(question) + strlen(answer)+1);
    strcpy(data,question);
    strcat(data, "JNI说:");
    strcat(data, answer);
    return env-&gt;NewStringUTF(data);
}
</pre>
<p style="margin-top:0px; margin-bottom:16px; color:rgb(36,41,46); font-size:16px">
我这里用的是&nbsp;<span style="font-weight:600">c++</span>&nbsp;所以得加上&nbsp;<span style="font-weight:600">extern "C"</span>&nbsp;，原因很简单，在&nbsp;<span style="font-weight:600">C++</span>&nbsp;中函数在编译的时候会拼接上参数，这也是&nbsp;<span style="font-weight:600">c++</span>&nbsp;中函数重载的处理机制，比如一个&nbsp;<span style="font-weight:600">set(int
 a)</span>&nbsp;和一个&nbsp;<span style="font-weight:600">set(int a,int b)</span>&nbsp;，在编译的时候就变成了&nbsp;<span style="font-weight:600">set_int</span>&nbsp;与&nbsp;<span style="font-weight:600">set_int_int</span>&nbsp;，我们加上<span style="font-weight:600">extern ”C“</span>&nbsp;就表示大爷想按照C来编译，所以函数名字后面就不会拼接上参数类型了。<br style="">
<br style="">
5、在jni目录下新建两个文件一个叫&nbsp;<span style="font-weight:600">Android.mk</span>&nbsp;,一个叫&nbsp;<span style="font-weight:600">Application.mk</span>&nbsp;。<br style="">
<br style="">
6、编写Android.mk，最简单的编写如下，后面将介绍一些稍微牛逼点点的。<br style="">
</p>
<pre style="font-family:SFMono-Regular,Consolas,&quot;Liberation Mono&quot;,Menlo,Courier,monospace; font-size:13.6px; margin-top:0px; margin-bottom:16px; line-height:1.45; word-wrap:normal; padding:16px; overflow:auto; background-color:rgb(246,248,250); color:rgb(36,41,46)"><code style="font-family:SFMono-Regular,Consolas,&quot;Liberation Mono&quot;,Menlo,Courier,monospace; font-size:13.6px; padding:0px; margin:0px; background:transparent; word-break:normal; border:0px; display:inline; overflow:visible; line-height:inherit; word-wrap:normal">
LOCAL_PATH := $(call my-dir)
include $(CLEAR_VARS)
LOCAL_MODULE := hi_jni
LOCAL_SRC_FILES := hi_jni.cpp
LOCAL_C_INCLUDES += $(LOCAL_PATH)
 #LOCAL_LDLIBS := -llog
include $(BUILD_SHARED_LIBRARY)
</code></pre>
<p style="margin-top:0px; margin-bottom:16px; color:rgb(36,41,46); font-size:16px">
<span style="font-weight:600">LOCAL_PATH</span>&nbsp;：是得最先配置的，它用于在开发tree中查找源文件。<br style="">
<br style="">
<span style="font-weight:600">include $(CLEAR_VARS)</span>&nbsp;：&nbsp;<span style="font-weight:600">CLEAR_VARS</span>&nbsp;变量指向特殊&nbsp;<span style="font-weight:600">GNU Makefile</span>&nbsp;，可为您清除许多&nbsp;<span style="font-weight:600">LOCAL_XXX</span>&nbsp;变量，例如<span style="font-weight:600">LOCAL_MODULE</span>&nbsp;、&nbsp;<span style="font-weight:600">LOCAL_SRC_FILES</span>&nbsp;和&nbsp;<span style="font-weight:600">LOCAL_STATIC_LIBRARIES</span>&nbsp;。
 请注意，它不会清除&nbsp;<span style="font-weight:600">LOCAL_PATH</span>&nbsp;<br style="">
<br style="">
<span style="font-weight:600">LOCAL_PATH</span>&nbsp;:此变量必须保留其值，因为系统在单一&nbsp;<span style="font-weight:600">GNU Make</span>&nbsp;执行环境（其中所有变量都是全局的）中解析所有构建控制文件。 在描述每个模块之前，必须声明（重新声明）此变量。<br style="">
<br style="">
<span style="font-weight:600">LOCAL_MODULE</span>&nbsp;：存储您要构建的模块的名称,并指定想生成的&nbsp;<span style="font-weight:600">so</span>&nbsp;叫什么名字。当然生成产物的时候前面会自动拼接上&nbsp;<span style="font-weight:600">lib</span>,后面会自动拼接上&nbsp;<span style="font-weight:600">.so</span>&nbsp;。<br style="">
<br style="">
<span style="font-weight:600">LOCAL_SRC_FILES</span>&nbsp;:要编译的源文件，多个文件以空格分开即可。当导入&nbsp;<span style="font-weight:600">.a</span>&nbsp;或者&nbsp;<span style="font-weight:600">.so</span>&nbsp;文件的时候一个模块只能添加一个文件，后面将演示。<br style="">
<br style="">
<span style="font-weight:600">LOCAL_C_INCLUDES</span>&nbsp;:可以使用此可选变量指定相对于&nbsp;<span style="font-weight:600">NDK root</span>&nbsp;目录的路径列表，以便在编译所有源文件（C、C++ 和 Assembly）时添加到 include 搜索路径，通常是原文件地址、头文件地址等。<br style="">
<span style="font-weight:600">LOCAL_LDLIBS</span>&nbsp;:这里是添加一个本地依赖库，比如可以添加一个&nbsp;<span style="font-weight:600">log</span>&nbsp;库，当然我没用到就注释了。<br style="">
<br style="">
<span style="font-weight:600">include $(BUILD_SHARED_LIBRARY)</span>&nbsp;:这一行帮助系统将所有内容连接到一起，&nbsp;<span style="font-weight:600">BUILD_SHARED_LIBRARY</span>&nbsp;变量指向<span style="font-weight:600">GNU Makefile</span>&nbsp;脚本，用于收集您自最近 include 后在&nbsp;<span style="font-weight:600">LOCAL_XXX</span>&nbsp;变量中定义的所有信息。
 此脚本确定要构建的内容及其操作方法。&nbsp;<span style="font-weight:600">BUILD_SHARED_LIBRARY</span>&nbsp;代表动态库，&nbsp;<span style="font-weight:600">BUILD_STATIC_LIBRARY</span>&nbsp;代表静态库 。<br style="">
<br style="">
</p>
<p style="margin-top:0px; margin-bottom:16px; color:rgb(36,41,46); font-size:16px">
7、编写&nbsp;<span style="font-weight:600">Application.mk</span>&nbsp;：</p>
<pre style="font-family:SFMono-Regular,Consolas,&quot;Liberation Mono&quot;,Menlo,Courier,monospace; font-size:13.6px; margin-top:0px; margin-bottom:16px; line-height:1.45; word-wrap:normal; padding:16px; overflow:auto; background-color:rgb(246,248,250); color:rgb(36,41,46)"><code style="font-family:SFMono-Regular,Consolas,&quot;Liberation Mono&quot;,Menlo,Courier,monospace; font-size:13.6px; padding:0px; margin:0px; background:transparent; word-break:normal; border:0px; display:inline; overflow:visible; line-height:inherit; word-wrap:normal">
	# 指定生成哪些cpu架构的库
	APP_ABI := armeabi-v7a
	# 此变量包含目标 Android 平台的名称
	APP_PLATFORM := android-22
</code></pre>
<p style="margin-top:0px; margin-bottom:16px; color:rgb(36,41,46); font-size:16px">
8、在&nbsp;<span style="font-weight:600">jni</span>&nbsp;目录下面打开命令行工具，然后执行&nbsp;<span style="font-weight:600">ndk-build</span>&nbsp;,即可在&nbsp;<span style="font-weight:600">libs</span>&nbsp;目录下得到产物:<br style="">
<br style="">
<a target="_blank" href="https://github.com/mabeijianxi/pic-trusteeship/blob/master/pic/jni/jni_7.png" style="background-color:transparent; color:rgb(3,102,214)"><img src="https://github.com/mabeijianxi/pic-trusteeship/raw/master/pic/jni/jni_7.png" alt="" style="border-style:none; max-width:100%"></a><a target="_blank" href="https://github.com/mabeijianxi/pic-trusteeship/blob/master/pic/jni/jni_8.png" style="background-color:transparent; color:rgb(3,102,214)"><img src="https://github.com/mabeijianxi/pic-trusteeship/raw/master/pic/jni/jni_8.png" alt="" style="border-style:none; max-width:100%"></a><br style="">
<br style="">
9、把产物放到&nbsp;<span style="font-weight:600">jniLibs</span>&nbsp;下面（当然你可以在采用&nbsp;<span style="font-weight:600">builde.gradle</span>&nbsp;的&nbsp;<span style="font-weight:600">sourceSets</span>&nbsp;里面改变其路径，&nbsp;<span style="font-weight:600">jniLibs.srcDirs=['src/main/libs']）</span>&nbsp;。<br style="">
<br style="">
<a target="_blank" href="https://github.com/mabeijianxi/pic-trusteeship/blob/master/pic/jni/jni_9.png" style="background-color:transparent; color:rgb(3,102,214)"><img src="https://github.com/mabeijianxi/pic-trusteeship/raw/master/pic/jni/jni_9.png" alt="" style="border-style:none; max-width:100%"></a><br style="">
<br style="">
</p>
<p style="margin-top:0px; margin-bottom:16px; color:rgb(36,41,46); font-size:16px">
10、&nbsp;<span style="font-weight:600">Java</span>&nbsp;层调用：</p>
<pre style="font-family:SFMono-Regular,Consolas,&quot;Liberation Mono&quot;,Menlo,Courier,monospace; font-size:13.6px; margin-top:0px; margin-bottom:16px; line-height:1.45; word-wrap:normal; padding:16px; overflow:auto; background-color:rgb(246,248,250); color:rgb(36,41,46)"><code style="font-family:SFMono-Regular,Consolas,&quot;Liberation Mono&quot;,Menlo,Courier,monospace; font-size:13.6px; padding:0px; margin:0px; background:transparent; word-break:normal; border:0px; display:inline; overflow:visible; line-height:inherit; word-wrap:normal">
 private  String TAG= getClass().getSimpleName();
    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_main);
        String s = jniTellMeWhy("我是MainActivity,tell me why!");
        Log.e(TAG,s);
    }
    private native String jniTellMeWhy(String hiJni);
    static {
        System.loadLibrary("hi_jni");
    }
</code></pre>
<p style="margin-top:0px; margin-bottom:16px; color:rgb(36,41,46); font-size:16px">
结果是：<a target="_blank" href="https://github.com/mabeijianxi/pic-trusteeship/blob/master/pic/jni/jni_5.png" style="background-color:transparent; color:rgb(3,102,214)"><img src="https://github.com/mabeijianxi/pic-trusteeship/raw/master/pic/jni/jni_5.png" alt="" style="border-style:none; max-width:100%"></a><br style="">
<br style="">
<span style="font-weight:600">添加一预构建库编译：</span>&nbsp;<br style="">
<br style="">
其实和咋们Android中的添加依赖差不多，我们要编译一个原生库，这个库的功能是可以按照&nbsp;<span style="font-weight:600">H264</span>&nbsp;编码视频，然后我们不想自己写那么多代码，所以我们引入开源的&nbsp;<span style="font-weight:600">libx264</span>&nbsp;，我们拿到编译好的&nbsp;<span style="font-weight:600">libx264.a</span>&nbsp;或者&nbsp;<span style="font-weight:600">libx264.so</span>&nbsp;和其头文件，这个时候我们只需要导入一起编译即可：
 目录结构如图<br style="">
<a target="_blank" href="https://github.com/mabeijianxi/pic-trusteeship/blob/master/pic/jni/jni_10.png" style="background-color:transparent; color:rgb(3,102,214)"><img src="https://github.com/mabeijianxi/pic-trusteeship/raw/master/pic/jni/jni_10.png" alt="" style="border-style:none; max-width:100%"></a><br style="">
<br style="">
有了头文件我们即可include入我们的&nbsp;<span style="font-weight:600">hi_jni.cpp</span>&nbsp;里面自由蹂蹑。<br style="">
<br style="">
接下来修改下&nbsp;<span style="font-weight:600">Android.mk</span>&nbsp;。<br style="">
</p>
<pre style="font-family:SFMono-Regular,Consolas,&quot;Liberation Mono&quot;,Menlo,Courier,monospace; font-size:13.6px; margin-top:0px; margin-bottom:16px; line-height:1.45; word-wrap:normal; padding:16px; overflow:auto; background-color:rgb(246,248,250); color:rgb(36,41,46)"><code style="font-family:SFMono-Regular,Consolas,&quot;Liberation Mono&quot;,Menlo,Courier,monospace; font-size:13.6px; padding:0px; margin:0px; background:transparent; word-break:normal; border:0px; display:inline; overflow:visible; line-height:inherit; word-wrap:normal">
LOCAL_PATH := $(call my-dir)
	#第一组
include $(CLEAR_VARS)
LOCAL_MODULE := x264
LOCAL_SRC_FILES := $(LOCAL_PATH)/x264/libx264.a
LOCAL_C_INCLUDES += $(LOCAL_PATH)/include/
include $(PREBUILT_STATIC_LIBRARY)
	#第二组
include $(CLEAR_VARS)
LOCAL_MODULE := hi_jni
LOCAL_SRC_FILES := hi_jni.cpp
LOCAL_C_INCLUDES += $(LOCAL_PATH)
LOCAL_STATIC_LIBRARIES := x264
include $(BUILD_SHARED_LIBRARY
</code></pre>
<p style="margin-top:0px; margin-bottom:16px; color:rgb(36,41,46); font-size:16px">
如果我们导入&nbsp;<span style="font-weight:600">.a</span>&nbsp;的静态库的话第一组就如上所写，每添加一组的时候必须执行&nbsp;<span style="font-weight:600">include $(CLEAR_VARS)</span>&nbsp;，<span style="font-weight:600">LOCAL_MODULE</span>&nbsp;的值就各自喜好了，第一组的&nbsp;<span style="font-weight:600">LOCAL_SRC_FILES</span>&nbsp;我们指向想导入的静态库地址，第一组的<span style="font-weight:600">LOCAL_C_INCLUDES</span>&nbsp;指向其头文件地址，然后&nbsp;<span style="font-weight:600">include
 $(PREBUILT_STATIC_LIBRARY）</span>&nbsp;代表生成静态预构建。 我们在第二组中引用第一组的静态预构建也就是&nbsp;<span style="font-weight:600">LOCAL_STATIC_LIBRARIES := x264</span>&nbsp;，引用动态预构建只需把&nbsp;<span style="font-weight:600">STATIC</span>&nbsp;修改为<span style="font-weight:600">SHARED</span>&nbsp;即可。配置完成即可在当前目录打开命令行执行&nbsp;<span style="font-weight:600">ndk-build</span>&nbsp;命令生成产物。如果第一组你指定的是&nbsp;<span style="font-weight:600">.so</span>&nbsp;的动态库，使用的时候也得在&nbsp;<span style="font-weight:600">java</span>&nbsp;层&nbsp;<span style="font-weight:600">System.loadLibrary("x264")</span>&nbsp;。</p>
<h2 style="margin-top:24px; margin-bottom:16px; line-height:1.25; padding-bottom:0.3em; border-bottom:1px solid rgb(234,236,239); color:rgb(36,41,46)"><a name="t1" target="_blank"></a>
<a target="_blank" id="user-content-二通过配置as中buildgradle来编译" class="anchor" href="https://github.com/mabeijianxi/pic-trusteeship/blob/master/README.md#二通过配置as中buildgradle来编译" style="background-color:transparent; color:rgb(3,102,214); float:left; padding-right:4px; margin-left:-20px; line-height:1"></a>二、通过配置AS中build.gradle来编译：<br style="">
</h2>
<p style="margin-top:0px; margin-bottom:16px; color:rgb(36,41,46); font-size:16px">
这种方式比上一中又简化了很多，无需再自己编写&nbsp;<span style="font-weight:600">Android.mk</span>&nbsp;了，但原理都是一样的。 1、在&nbsp;<span style="font-weight:600">main</span>&nbsp;下新建&nbsp;<span style="font-weight:600">jni</span>&nbsp;目录，如图：<br style="">
<a target="_blank" href="https://github.com/mabeijianxi/pic-trusteeship/blob/master/pic/jni/jni_2.png" style="background-color:transparent; color:rgb(3,102,214)"><img src="https://github.com/mabeijianxi/pic-trusteeship/raw/master/pic/jni/jni_2.png" alt="" style="border-style:none; max-width:100%"></a><br style="">
<br style="">
2、再新建一个&nbsp;<span style="font-weight:600">c</span>&nbsp;或者&nbsp;<span style="font-weight:600">c++</span>&nbsp;文件，如图：<br style="">
<a target="_blank" href="https://github.com/mabeijianxi/pic-trusteeship/blob/master/pic/jni/jni_3.png" style="background-color:transparent; color:rgb(3,102,214)"><img src="https://github.com/mabeijianxi/pic-trusteeship/raw/master/pic/jni/jni_3.png" alt="" style="border-style:none; max-width:100%"></a><br style="">
<br style="">
3、找到你项目的&nbsp;<span style="font-weight:600">gradle.properties</span>&nbsp;，添加一行&nbsp;<span style="font-weight:600">android.useDeprecatedNdk=true</span>&nbsp;<br style="">
<br style="">
4、打开你主&nbsp;<span style="font-weight:600">Module</span>&nbsp;的&nbsp;<span style="font-weight:600">build.gradle</span>&nbsp;,在&nbsp;<span style="font-weight:600">defaultConfig</span>&nbsp;里添加:<br style="">
<br style="">
</p>
<pre style="font-family:SFMono-Regular,Consolas,&quot;Liberation Mono&quot;,Menlo,Courier,monospace; font-size:13.6px; margin-top:0px; margin-bottom:16px; line-height:1.45; word-wrap:normal; padding:16px; overflow:auto; background-color:rgb(246,248,250); color:rgb(36,41,46)"><code style="font-family:SFMono-Regular,Consolas,&quot;Liberation Mono&quot;,Menlo,Courier,monospace; font-size:13.6px; padding:0px; margin:0px; background:transparent; word-break:normal; border:0px; display:inline; overflow:visible; line-height:inherit; word-wrap:normal">
	ndk{
            moduleName 'hi_jni'
            abiFilter 'armeabi-v7a'
        }
</code></pre>
<p style="margin-top:0px; margin-bottom:16px; color:rgb(36,41,46); font-size:16px">
名如其实，&nbsp;<span style="font-weight:600">moduleName</span>&nbsp;是你给生成的&nbsp;<span style="font-weight:600">So</span>&nbsp;取的名字，当然它会在前面拼接上 “&nbsp;<span style="font-weight:600">lib</span>&nbsp;”，会在后面拼接上&nbsp;<span style="font-weight:600">.so</span>&nbsp;，于是生成的名字就&nbsp;<span style="font-weight:600">libhi_jni.so</span>&nbsp;,&nbsp;<span style="font-weight:600">abiFilter</span>&nbsp;嘛就是你想保留哪些<a href="http://lib.csdn.net/base/architecture" class="replace_word" title="大型网站架构知识库" target="_blank" style="color:#df3434; font-weight:bold;">架构</a>类型的&nbsp;<span style="font-weight:600">so</span>&nbsp;，一般&nbsp;<span style="font-weight:600">arm</span>&nbsp;的就够玩了，当然除了这些还有很多可配参数,比如想添加个日志库来玩玩，那就添加这行呗:&nbsp;<span style="font-weight:600">IdLibs
 “log“</span>&nbsp;。<br style="">
<br style="">
5、同 徒手编写Android.mk然后ndk-build编译 中的 3。<br style="">
<br style="">
6、同 徒手编写Android.mk然后ndk-build编译 中的 4.<br style="">
<br style="">
7、同 徒手编写Android.mk然后ndk-build编译 中的 10.<br style="">
<br style="">
</p>
<p style="margin-top:0px; margin-bottom:16px; color:rgb(36,41,46); font-size:16px">
这种方式不仅 so easy,当配置好后编译器还能帮我们像在写&nbsp;<span style="font-weight:600">Java</span>&nbsp;代码一样做代码提示。我们可以打开 主&nbsp;<span style="font-weight:600">Mudoul下debug-&gt;ndk</span>&nbsp;文件夹:<br style="">
<a target="_blank" href="https://github.com/mabeijianxi/pic-trusteeship/blob/master/pic/jni/jni_6.png" style="background-color:transparent; color:rgb(3,102,214)"><img src="https://github.com/mabeijianxi/pic-trusteeship/raw/master/pic/jni/jni_6.png" alt="" style="border-style:none; max-width:100%"></a><br style="">
看自动给我们生成了&nbsp;<span style="font-weight:600">Android.mk</span>&nbsp;，所以说原理都是一样的。<br style="">
<br style="">
</p>
<h2 style="margin-top:24px; margin-bottom:16px; line-height:1.25; padding-bottom:0.3em; border-bottom:1px solid rgb(234,236,239); color:rgb(36,41,46)"><a name="t2" target="_blank"></a>
<a target="_blank" id="user-content-三通过as的cmake插件编译" class="anchor" href="https://github.com/mabeijianxi/pic-trusteeship/blob/master/README.md#三通过as的cmake插件编译" style="background-color:transparent; color:rgb(3,102,214); float:left; padding-right:4px; margin-left:-20px; line-height:1"></a>三、通过AS的cMake插件编译：</h2>
<p style="margin-top:0px; margin-bottom:16px; color:rgb(36,41,46); font-size:16px">
没错，今天的重头戏就是这个，也是必须把AS升级到2.2以后才能玩的功能，有了它写原生代码可谓是如鱼得水，做到真走的徒手一千行，没有比友基！<br style="">
</p>
<p style="margin-top:0px; margin-bottom:16px; color:rgb(36,41,46); font-size:16px">
怎么玩？点点啊，我靠只需要在新建项目的时候打个钩：<br style="">
<br style="">
<a target="_blank" href="https://github.com/mabeijianxi/pic-trusteeship/blob/master/pic/jni/jni_11.png" style="background-color:transparent; color:rgb(3,102,214)"><img src="https://github.com/mabeijianxi/pic-trusteeship/raw/master/pic/jni/jni_11.png" alt="" style="border-style:none; max-width:100%"></a>,没错勾上
 Incude C++ Support,然后呢？然后就是直接运行即可。<br style="">
<br style="">
这是自动生成的部分&nbsp;<span style="font-weight:600">c++</span>&nbsp;代码:<br style="">
</p>
<pre style="font-family:SFMono-Regular,Consolas,&quot;Liberation Mono&quot;,Menlo,Courier,monospace; font-size:13.6px; margin-top:0px; margin-bottom:16px; line-height:1.45; word-wrap:normal; padding:16px; overflow:auto; background-color:rgb(246,248,250); color:rgb(36,41,46)"><code style="font-family:SFMono-Regular,Consolas,&quot;Liberation Mono&quot;,Menlo,Courier,monospace; font-size:13.6px; padding:0px; margin:0px; background:transparent; word-break:normal; border:0px; display:inline; overflow:visible; line-height:inherit; word-wrap:normal">
	extern "C"
jstring
Java_com_example_jianxi_x264test1_MainActivity_stringFromJNI(
        JNIEnv *env,
        jobject /* this */,jstring str) {
    std::string hello = "Hello from C++";
    return env-&gt;NewStringUTF(hello.c_str());
}
</code></pre>
<p style="margin-top:0px; margin-bottom:16px; color:rgb(36,41,46); font-size:16px">
这是自动生成的部分Java代码：<br style="">
</p>
<pre style="font-family:SFMono-Regular,Consolas,&quot;Liberation Mono&quot;,Menlo,Courier,monospace; font-size:13.6px; margin-top:0px; margin-bottom:16px; line-height:1.45; word-wrap:normal; padding:16px; overflow:auto; background-color:rgb(246,248,250); color:rgb(36,41,46)"><code style="font-family:SFMono-Regular,Consolas,&quot;Liberation Mono&quot;,Menlo,Courier,monospace; font-size:13.6px; padding:0px; margin:0px; background:transparent; word-break:normal; border:0px; display:inline; overflow:visible; line-height:inherit; word-wrap:normal">

		public class MainActivity extends AppCompatActivity {

    // Used to load the 'native-lib' library on application startup.
    static {
        System.loadLibrary("native-lib");
    }

    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_main);

        // Example of a call to a native method
        TextView tv = (TextView) findViewById(R.id.sample_text);
        tv.setText(stringFromJNI());
    }

    /**
     * A native method that is implemented by the 'native-lib' native library,
     * which is packaged with this application.
     */
    public native String stringFromJNI();
}
</code></pre>
<p style="margin-top:0px; margin-bottom:16px; color:rgb(36,41,46); font-size:16px">
<span style="font-weight:600">自动生成的build.gradle里面多出了这两个东西</span>&nbsp;<br style="">
<br style="">
<span style="font-weight:600">android</span>&nbsp;里多了：</p>
<pre style="font-family:SFMono-Regular,Consolas,&quot;Liberation Mono&quot;,Menlo,Courier,monospace; font-size:13.6px; margin-top:0px; margin-bottom:16px; line-height:1.45; word-wrap:normal; padding:16px; overflow:auto; background-color:rgb(246,248,250); color:rgb(36,41,46)"><code style="font-family:SFMono-Regular,Consolas,&quot;Liberation Mono&quot;,Menlo,Courier,monospace; font-size:13.6px; padding:0px; margin:0px; background:transparent; word-break:normal; border:0px; display:inline; overflow:visible; line-height:inherit; word-wrap:normal">
	externalNativeBuild {
        cmake {
            path "CMakeLists.txt"
        }
    }
</code></pre>
<br style="color:rgb(36,41,46); font-size:16px">
<p style="margin-top:0px; margin-bottom:16px; color:rgb(36,41,46); font-size:16px">
<span style="font-weight:600">defaultConfig</span>&nbsp;里多了:</p>
<pre style="font-family:SFMono-Regular,Consolas,&quot;Liberation Mono&quot;,Menlo,Courier,monospace; font-size:13.6px; margin-top:0px; margin-bottom:16px; line-height:1.45; word-wrap:normal; padding:16px; overflow:auto; background-color:rgb(246,248,250); color:rgb(36,41,46)"><code style="font-family:SFMono-Regular,Consolas,&quot;Liberation Mono&quot;,Menlo,Courier,monospace; font-size:13.6px; padding:0px; margin:0px; background:transparent; word-break:normal; border:0px; display:inline; overflow:visible; line-height:inherit; word-wrap:normal">
	externalNativeBuild {
            cmake {
                cppFlags ""
            }
        }
</code></pre>
<p style="margin-top:0px; margin-bottom:16px; color:rgb(36,41,46); font-size:16px">
在主&nbsp;<span style="font-weight:600">Mudule</span>&nbsp;的跟目录下多了个&nbsp;<span style="font-weight:600">CMakeLists.txt</span>&nbsp;，我们定制自己的原生代码的时候主要就是修改&nbsp;<span style="font-weight:600">CMakeLists.txt</span>&nbsp;里面的配置，下面也会详细讲解.<br style="">
<br style="">
</p>
<h3 style="margin-top:24px; margin-bottom:16px; font-size:1.25em; line-height:1.25; color:rgb(36,41,46)"><a name="t3" target="_blank"></a>
<a target="_blank" id="user-content-在原生代码里面添加本地库" class="anchor" href="https://github.com/mabeijianxi/pic-trusteeship/blob/master/README.md#在原生代码里面添加本地库" style="background-color:transparent; color:rgb(3,102,214); float:left; padding-right:4px; margin-left:-20px; line-height:1"></a>在原生代码里面添加本地库：</h3>
<p style="margin-top:0px; margin-bottom:16px; color:rgb(36,41,46); font-size:16px">
这里以&nbsp;<span style="font-weight:600">log</span>&nbsp;库为例，&nbsp;<span style="font-weight:600">log</span>&nbsp;库是&nbsp;<span style="font-weight:600">android</span>&nbsp;下的，如果我们新建项目的时候勾选上了&nbsp;<span style="font-weight:600">Incude C++ Support</span>&nbsp;，那么自动生成的<span style="font-weight:600">CMakeLists.txt</span>&nbsp;里面默认会为我们添加&nbsp;<span style="font-weight:600">log</span>&nbsp;库，置于&nbsp;<span style="font-weight:600">CMakeLists.txt</span>&nbsp;的配置一会儿道来。<br style="">
<br style="">
</p>
<p style="margin-top:0px; margin-bottom:16px; color:rgb(36,41,46); font-size:16px">
下面是导入&nbsp;<span style="font-weight:600">log</span>&nbsp;库的头文件，并且宏定义&nbsp;<span style="font-weight:600">log</span>&nbsp;打印函数的代码:</p>
<pre style="font-family:SFMono-Regular,Consolas,&quot;Liberation Mono&quot;,Menlo,Courier,monospace; font-size:13.6px; margin-top:0px; margin-bottom:16px; line-height:1.45; word-wrap:normal; padding:16px; overflow:auto; background-color:rgb(246,248,250); color:rgb(36,41,46)"><code style="font-family:SFMono-Regular,Consolas,&quot;Liberation Mono&quot;,Menlo,Courier,monospace; font-size:13.6px; padding:0px; margin:0px; background:transparent; word-break:normal; border:0px; display:inline; overflow:visible; line-height:inherit; word-wrap:normal">
	</code><p class="p1"><span class="s1"><span style="white-space:pre">	</span> #include &lt;android/log.h&gt;</span></p>	#define LOG_TAG "来自jni:"
	#define  LOGE(...)  __android_log_print(ANDROID_LOG_ERROR,LOG_TAG,__VA_ARGS__)
</pre>
<p style="margin-top:0px; margin-bottom:16px; color:rgb(36,41,46); font-size:16px">
我们这里宏定义了个&nbsp;<span style="font-weight:600">LOG_TAG</span>&nbsp;,并宏定义打印函数&nbsp;<span style="font-weight:600">__android_log_print</span>&nbsp;，我们传入&nbsp;<span style="font-weight:600">ANDROID_LOG_ERROR</span>&nbsp;，所以是E级别。<br style="">
<br style="">
使用:<br style="">
</p>
<pre style="font-family:SFMono-Regular,Consolas,&quot;Liberation Mono&quot;,Menlo,Courier,monospace; font-size:13.6px; margin-top:0px; margin-bottom:16px; line-height:1.45; word-wrap:normal; padding:16px; overflow:auto; background-color:rgb(246,248,250); color:rgb(36,41,46)"><code style="font-family:SFMono-Regular,Consolas,&quot;Liberation Mono&quot;,Menlo,Courier,monospace; font-size:13.6px; padding:0px; margin:0px; background:transparent; word-break:normal; border:0px; display:inline; overflow:visible; line-height:inherit; word-wrap:normal">
extern "C"
jstring
Java_com_example_jianxi_jnidemo_MainActivity_jniTellMeWhy(JNIEnv *env, jobject obj, jstring str) {
    const char *question = env-&gt;GetStringUTFChars(str, JNI_FALSE);
    char *answer = "fuck,no why!!!";
    char *data = (char *) malloc(strlen(question) + strlen(answer)+1);
    strcpy(data,question);
    strcat(data, "JNI说:");
    strcat(data, answer);
    LOGE("我在hi_jni.cpp里面和你撩呢!");
    return env-&gt;NewStringUTF(data);
}
</code></pre>
<p style="margin-top:0px; margin-bottom:16px; color:rgb(36,41,46); font-size:16px">
<span style="font-weight:600">输出结果:</span>&nbsp;<br style="">
<br style="">
<a target="_blank" href="https://github.com/mabeijianxi/pic-trusteeship/blob/master/pic/jni/jni_12.png" style="background-color:transparent; color:rgb(3,102,214)"><img src="https://github.com/mabeijianxi/pic-trusteeship/raw/master/pic/jni/jni_12.png" alt="" style="border-style:none; max-width:100%"></a><br style="">
<br style="">
当然我们平时玩&nbsp;<span style="font-weight:600">log</span>&nbsp;总是有一个总开关的，这里我们也可以定义一个，这个开关我们放在&nbsp;<span style="font-weight:600">build.gradle</span>&nbsp;里面:<br style="">
<br style="">
<a target="_blank" href="https://github.com/mabeijianxi/pic-trusteeship/blob/master/pic/jni/jni_13.png" style="background-color:transparent; color:rgb(3,102,214)"><img src="https://github.com/mabeijianxi/pic-trusteeship/raw/master/pic/jni/jni_13.png" alt="" style="border-style:none; max-width:100%"></a><br style="">
<br style="">
,没错&nbsp;<span style="font-weight:600">-D</span>&nbsp;命令就是宏定义，这里我们宏定义了一个&nbsp;<span style="font-weight:600">Debug</span>&nbsp;。接下来我们在原生代码里面我们就可以根据是否定义了这个宏来决定是否输出日志。代码如下:</p>
<pre style="font-family:SFMono-Regular,Consolas,&quot;Liberation Mono&quot;,Menlo,Courier,monospace; font-size:13.6px; margin-top:0px; margin-bottom:16px; line-height:1.45; word-wrap:normal; padding:16px; overflow:auto; background-color:rgb(246,248,250); color:rgb(36,41,46)"><code style="font-family:SFMono-Regular,Consolas,&quot;Liberation Mono&quot;,Menlo,Courier,monospace; font-size:13.6px; padding:0px; margin:0px; background:transparent; word-break:normal; border:0px; display:inline; overflow:visible; line-height:inherit; word-wrap:normal">
 </code><p class="p1"><span class="s1"> #include &lt;jni.h&gt;</span></p><p class="p1"><span class="s2">&nbsp;</span><span class="s1">#include &lt;stdio.h&gt;</span></p><p class="p1"><span class="s2">&nbsp;</span><span class="s1">#include &lt;stdlib.h&gt;</span></p> # ifdef Debug
<p class="p1"><span class="s1"> #include &lt;android/log.h&gt;</span></p> #define LOG_TAG "来自jni:"
 #define  LOGE(...)  __android_log_print(ANDROID_LOG_ERROR,LOG_TAG,__VA_ARGS__)
 # endif
extern "C"
jstring
Java_com_example_jianxi_jnidemo_MainActivity_jniTellMeWhy(JNIEnv *env, jobject obj, jstring str) {
    const char *question = env-&gt;GetStringUTFChars(str, JNI_FALSE);
    char *answer = "fuck,no why!!!";
    
   char *data = (char *) malloc(strlen(question) + strlen(answer)+1);
   strcpy(data,question);
   strcat(data, "JNI说:");
   strcat(data, answer);
 #ifdef Debug
    LOGE("我在hi_jni.cpp里面和你撩呢!");
 # endif
    return env-&gt;NewStringUTF(data);
}
</pre>
<h3 style="margin-top:24px; margin-bottom:16px; font-size:1.25em; line-height:1.25; color:rgb(36,41,46)"><a name="t4" target="_blank"></a>
<a target="_blank" id="user-content-接下我们仔细研究下-cmakeliststxt" class="anchor" href="https://github.com/mabeijianxi/pic-trusteeship/blob/master/README.md#接下我们仔细研究下-cmakeliststxt" style="background-color:transparent; color:rgb(3,102,214); float:left; padding-right:4px; margin-left:-20px; line-height:1"></a>接下我们仔细研究下
 CMakeLists.txt<br style="">
</h3>
<p style="margin-top:0px; margin-bottom:16px; color:rgb(36,41,46); font-size:16px">
我复制了里面自动生成的一些关键脚本：</p>
<pre style="font-family:SFMono-Regular,Consolas,&quot;Liberation Mono&quot;,Menlo,Courier,monospace; font-size:13.6px; margin-top:0px; margin-bottom:16px; line-height:1.45; word-wrap:normal; padding:16px; overflow:auto; background-color:rgb(246,248,250); color:rgb(36,41,46)">	add_library( # Sets the name of the library.
             hi_jni
             # Sets the library as a shared library.
             SHARED
             # Provides a relative path to your source file(s).
             # Associated headers in the same location as their source
             # file are automatically included.
             src/main/cpp/hi_jni.cpp )
 # Searches for a specified prebuilt library and stores the path as a
 # variable. Because system libraries are included in the search path by
 # default, you only need to specify the name of the public NDK library
 # you want to add. CMake verifies that the library exists before
 # completing its build.

find_library( # Sets the name of the path variable.
              log-lib
              # Specifies the name of the NDK library that
              # you want CMake to locate.
              log )

 # Specifies libraries CMake should link to your target library. You
 # can link multiple libraries, such as libraries you define in the
 # build script, prebuilt third-party libraries, or system libraries.

target_link_libraries( # Specifies the target library.
                       hi_jni
                       # Links the target library to the log library
                       # included in the NDK.
                       ${log-lib} )
</pre>
<p style="margin-top:0px; margin-bottom:16px; color:rgb(36,41,46); font-size:16px">
<span style="font-weight:600">add_library</span>&nbsp;:我们需要在里面指定三个东西，首先给&nbsp;<span style="font-weight:600">lib</span>&nbsp;取一个名字，然后指定作为动态库还是静态库，最后指定源文件或者库。使用&nbsp;<span style="font-weight:600">add_library()</span>&nbsp;向您的&nbsp;<span style="font-weight:600">CMake</span>&nbsp;构建脚本添加源文件或库时，&nbsp;<span style="font-weight:600">Android
 Studio</span>&nbsp;还会在您同步项目后在&nbsp;<span style="font-weight:600">Project</span>&nbsp;视图下显示关联的标头文件。不过，为了确保&nbsp;<span style="font-weight:600">CMake</span>&nbsp;可以在编译时定位您的标头文件，您需要将&nbsp;<span style="font-weight:600">include_directories()</span>&nbsp;命令添加到&nbsp;<span style="font-weight:600">CMake</span>&nbsp;构建脚本中并指定标头的路径：</p>
<pre style="font-family:SFMono-Regular,Consolas,&quot;Liberation Mono&quot;,Menlo,Courier,monospace; font-size:13.6px; margin-top:0px; margin-bottom:16px; line-height:1.45; word-wrap:normal; padding:16px; overflow:auto; background-color:rgb(246,248,250); color:rgb(36,41,46)">	add_library(...)

   # Specifies a path to native header files.
include_directories(src/main/cpp/include/)
</pre>
<p style="margin-top:0px; margin-bottom:16px; color:rgb(36,41,46); font-size:16px">
<span style="font-weight:600">find_library</span>&nbsp;:将&nbsp;<span style="font-weight:600">find_library()</span>&nbsp;命令添加到您的&nbsp;<span style="font-weight:600">CMake</span>&nbsp;构建脚本中以定位&nbsp;<span style="font-weight:600">NDK</span>&nbsp;库，并将其路径存储为一个变量。您可以使用此变量在构建脚本的其他部分引用&nbsp;<span style="font-weight:600">NDK</span>&nbsp;库。<br style="">
<span style="font-weight:600">target_link_libraries</span>&nbsp;:指定要关联到原生库的库，第一个自然是我们&nbsp;<span style="font-weight:600">add_library</span>&nbsp;里面指定的库名字&nbsp;<span style="font-weight:600">hi_jni</span>&nbsp;库，然后可以看到<span style="font-weight:600">${log-lib}</span>&nbsp;，也就是引用了&nbsp;<span style="font-weight:600">find_library</span>&nbsp;里面定义的日志库。<br style="">
经过上面的脚本，基本可以玩起来了。</p>
<h3 style="margin-top:24px; margin-bottom:16px; font-size:1.25em; line-height:1.25; color:rgb(36,41,46)"><a name="t5" target="_blank"></a>
<a target="_blank" id="user-content-引入其他编译好的静态库或者动态库" class="anchor" href="https://github.com/mabeijianxi/pic-trusteeship/blob/master/README.md#引入其他编译好的静态库或者动态库" style="background-color:transparent; color:rgb(3,102,214); float:left; padding-right:4px; margin-left:-20px; line-height:1"></a>引入其他编译好的静态库或者动态库</h3>
<p style="margin-top:0px; margin-bottom:16px; color:rgb(36,41,46); font-size:16px">
我们需要在&nbsp;<span style="font-weight:600">add_library</span>&nbsp;里面把我们的库&nbsp;<span style="font-weight:600">add</span>&nbsp;进去，也是三个参数，指定库名字，指定库类型，第三个指定为&nbsp;<span style="font-weight:600">IMPORTED</span>&nbsp;关键字即可，然后我们需要再添加个&nbsp;<span style="font-weight:600">set_target_properties()</span>&nbsp;命令，里面
 也是三个参数，要为其设置属性的库名称，指定其预构建类型，如 PROPERTIES&nbsp;<span style="font-weight:600">IMPORTED_LOCATION</span>&nbsp;，最后指定&nbsp;<span style="font-weight:600">.a .so</span>&nbsp;库的绝对地址。<br style="">
<br style="">
如图是我的目录结构:<br style="">
<br style="">
<a target="_blank" href="https://github.com/mabeijianxi/pic-trusteeship/blob/master/pic/jni/jni_14.png" style="background-color:transparent; color:rgb(3,102,214)"><img src="https://github.com/mabeijianxi/pic-trusteeship/raw/master/pic/jni/jni_14.png" alt="" style="border-style:none; max-width:100%"></a><br style="">
<br style="">
</p>
<pre style="font-family:SFMono-Regular,Consolas,&quot;Liberation Mono&quot;,Menlo,Courier,monospace; font-size:13.6px; margin-top:0px; margin-bottom:16px; line-height:1.45; word-wrap:normal; padding:16px; overflow:auto; background-color:rgb(246,248,250); color:rgb(36,41,46)">	add_library( # Sets the name of the library.
             hi_jni
             # Sets the library as a shared library.
             SHARED
             # Provides a relative path to your source file(s).
             # Associated headers in the same location as their source
             # file are automatically included.
             src/main/cpp/hi_jni.cpp )
 # Searches for a specified prebuilt library and stores the path as a
 # variable. Because system libraries are included in the search path by
 # default, you only need to specify the name of the public NDK library
 # you want to add. CMake verifies that the library exists before
 # completing its build.

add_library(
            x264
            STATIC
            IMPORTED
            )
set_target_properties(
    x264
    PROPERTIES IMPORTED_LOCATION
    /Users/jianxi/android/projects/o2o_2017_3_24_2.6.0/JNIDemo/app/src/main/cpp/x264/libx264.a
    )


include_directories(
    src/mian/cpp/include
)
find_library( # Sets the name of the path variable.
              log-lib
              # Specifies the name of the NDK library that
              # you want CMake to locate.
              log )

 # Specifies libraries CMake should link to your target library. You
 # can link multiple libraries, such as libraries you define in the
 # build script, prebuilt third-party libraries, or system libraries.

target_link_libraries( # Specifies the target library.
                       hi_jni
                       x264
                       # Links the target library to the log library
                       # included in the NDK.
                       ${log-lib} )
</pre>
<p style="margin-top:0px; margin-bottom:16px; color:rgb(36,41,46); font-size:16px">
由于我导入的&nbsp;<span style="font-weight:600">x264</span>&nbsp;静态库是&nbsp;<span style="font-weight:600">armeabi-v7a</span>&nbsp;架构的所以只能编译这个架构的，我需要在&nbsp;<span style="font-weight:600">builde.gradle</span>&nbsp;里面添加过滤:</p>
<pre style="font-family:SFMono-Regular,Consolas,&quot;Liberation Mono&quot;,Menlo,Courier,monospace; font-size:13.6px; margin-top:0px; margin-bottom:16px; line-height:1.45; word-wrap:normal; padding:16px; overflow:auto; background-color:rgb(246,248,250); color:rgb(36,41,46)">ndk{
abiFilters "armeabi-v7a"
}</pre>
<span style="color:rgb(36,41,46); font-size:16px">配置完成了我们现在试试导入&nbsp;</span><span style="font-weight:600; color:rgb(36,41,46); font-size:16px">x264</span><span style="color:rgb(36,41,46); font-size:16px">&nbsp;的头文件，调用下其默认参数配置函数玩玩，代码如下:</span>
<p style="margin-top:0px; margin-bottom:16px; color:rgb(36,41,46); font-size:16px">
</p>
<pre style="font-family:SFMono-Regular,Consolas,&quot;Liberation Mono&quot;,Menlo,Courier,monospace; font-size:13.6px; margin-top:0px; margin-bottom:16px; line-height:1.45; word-wrap:normal; padding:16px; overflow:auto; background-color:rgb(246,248,250); color:rgb(36,41,46)"><code style="font-family:SFMono-Regular,Consolas,&quot;Liberation Mono&quot;,Menlo,Courier,monospace; font-size:13.6px; padding:0px; margin:0px; background:transparent; word-break:normal; border:0px; display:inline; overflow:visible; line-height:inherit; word-wrap:normal">
 </code><p class="p1"><span class="s1"> #include &lt;jni.h&gt;</span></p><p class="p1"><span class="s2">&nbsp;</span><span class="s1">#include &lt;stdio.h&gt;</span></p><p class="p1"><span class="s2">&nbsp;</span><span class="s1">#include &lt;stdlib.h&gt;</span></p> # ifdef Debug
<p class="p1"><span class="s1"> #include &lt;android/log.h&gt;</span></p> #define LOG_TAG "来自jni:"
 #define  LOGE(...)  __android_log_print(ANDROID_LOG_ERROR,LOG_TAG,__VA_ARGS__)
 # endif

 #include "include/x264.h"
 extern "C"
 jstring
 Java_com_example_jianxi_jnidemo_MainActivity_jniTellMeWhy(JNIEnv *env, jobject obj,   jstring str) {
    const char *question = env-&gt;GetStringUTFChars(str, JNI_FALSE);
    char *answer = "fuck,no why!!!";
    char *data = (char *) malloc(strlen(question) + strlen(answer)+1);
    strcpy(data,question);
    strcat(data, "JNI说:");
    strcat(data, answer);
   x264_param_t * param=(x264_param_t *)malloc(sizeof(x264_param_t));
    x264_param_default(param);
 #ifdef Debug
    LOGE("我在hi_jni.cpp里面和你撩呢!");
    LOGE("i_bframe=%d\n",param-&gt;i_bframe);
    LOGE("i_level_idc=%d\n",param-&gt;i_level_idc);
 # endif
    delete param;
    return env-&gt;NewStringUTF(data);
}
</pre>
<p style="margin-top:0px; margin-bottom:16px; color:rgb(36,41,46); font-size:16px">
运行后输出结果如图:<a target="_blank" href="https://github.com/mabeijianxi/pic-trusteeship/blob/master/pic/jni/pic_15.png" style="background-color:transparent; color:rgb(3,102,214)"><img src="https://github.com/mabeijianxi/pic-trusteeship/raw/master/pic/jni/pic_15.png" alt="" style="border-style:none; max-width:100%"></a><br style="">
<br style="">
上面演示的是添加外部静态库，添加动态&nbsp;<span style="font-weight:600">so</span>&nbsp;库也大同小异，把&nbsp;<span style="font-weight:600">add_library（）</span>&nbsp;里面的&nbsp;<span style="font-weight:600">STATIC</span>&nbsp;改成&nbsp;<span style="font-weight:600">SHARED</span>&nbsp;即可编译。<br style="">
<br style="">
编译就是怎么简单,我们的全部配置其实都写入了另外一个脚本文件&nbsp;<span style="font-weight:600">cmake_build_command.txt</span>&nbsp;它的位置如图：<br style="">
<br style="">
<a target="_blank" href="https://github.com/mabeijianxi/pic-trusteeship/blob/master/pic/jni/jni_16.png" style="background-color:transparent; color:rgb(3,102,214)"><img src="https://github.com/mabeijianxi/pic-trusteeship/raw/master/pic/jni/jni_16.png" alt="" style="border-style:none; max-width:100%"></a><br style="">
<br style="">
我们点开看看:<br style="">
</p>
<pre style="font-family:SFMono-Regular,Consolas,&quot;Liberation Mono&quot;,Menlo,Courier,monospace; font-size:13.6px; margin-top:0px; margin-bottom:16px; line-height:1.45; word-wrap:normal; padding:16px; overflow:auto; background-color:rgb(246,248,250); color:rgb(36,41,46)">	Executable : /Users/jianxi/android/sdk/cmake/3.6.3155560/bin/cmake
arguments : 
-H/Users/jianxi/android/projects/o2o_2017_3_24_2.6.0/x264test1/app
-B/Users/jianxi/android/projects/o2o_2017_3_24_2.6.0/x264test1/app/.externalNativeBuild/cmake/debug/armeabi-v7a
-GAndroid Gradle - Ninja
-DANDROID_ABI=armeabi-v7a
-DANDROID_NDK=/Users/jianxi/android/sdk/ndk-bundle
-DCMAKE_LIBRARY_OUTPUT_DIRECTORY=/Users/jianxi/android/projects/o2o_2017_3_24_2.6.0/x264test1/app/build/intermediates/cmake/debug/obj/armeabi-v7a
-DCMAKE_BUILD_TYPE=Debug
-DCMAKE_MAKE_PROGRAM=/Users/jianxi/android/sdk/cmake/3.6.3155560/bin/ninja
-DCMAKE_TOOLCHAIN_FILE=/Users/jianxi/android/sdk/ndk-bundle/build/cmake/android.toolchain.cmake
-DANDROID_NATIVE_API_LEVEL=14
-DCMAKE_CXX_FLAGS=
jvmArgs : 
</pre>
<p style="margin-top:0px; margin-bottom:16px; color:rgb(36,41,46); font-size:16px">
参数的含义看官网的吧<a target="_blank" href="https://developer.android.google.cn/ndk/guides/cmake.html" style="background-color:transparent; color:rgb(3,102,214)"></a><a target="_blank" href="https://developer.android.google.cn/ndk/guides/cmake.html" style="background-color:transparent; color:rgb(3,102,214)">https://developer.android.google.cn/ndk/guides/cmake.html</a>,
 撸了七七四十九个小时，实在撸不动了，这些参数可以在build.gradle里面添加,如下:</p>
<pre style="font-family:SFMono-Regular,Consolas,&quot;Liberation Mono&quot;,Menlo,Courier,monospace; font-size:13.6px; margin-top:0px; margin-bottom:16px; line-height:1.45; word-wrap:normal; padding:16px; overflow:auto; background-color:rgb(246,248,250); color:rgb(36,41,46)">defaultConfig {
    ...
    // This block is different from the one you use to link Gradle
    // to your CMake build script.
    externalNativeBuild {
      cmake {
        ...
        // Use the following syntax when passing arguments to variables:
        // arguments "-DVAR_NAME=VALUE"
        arguments "-DANDROID_ARM_NEON=TRUE"
      }
    }
  }</pre>
<h2 style="margin-top:24px; margin-bottom:16px; line-height:1.25; padding-bottom:0.3em; border-bottom:1px solid rgb(234,236,239); color:rgb(36,41,46)"><a name="t6" target="_blank"></a>
<a target="_blank" id="user-content-总结" class="anchor" href="https://github.com/mabeijianxi/pic-trusteeship/blob/master/README.md#总结" style="background-color:transparent; color:rgb(3,102,214); float:left; padding-right:4px; margin-left:-20px; line-height:1"></a>总结</h2>
<p style="margin-top:0px; color:rgb(36,41,46); font-size:16px; margin-bottom:0px!important">
上面三种姿势肯定推荐第三种，&nbsp;<span style="font-weight:600">CMake</span>&nbsp;工具确实不错，也是&nbsp;<span style="font-weight:600">AS 2.2</span>&nbsp;推出的功能。在实际项目中肯定会有一些这样那样的问题，特别是导入一些像&nbsp;<span style="font-weight:600">FFmpeg</span>&nbsp;啊&nbsp;<span style="font-weight:600">x264</span>&nbsp;这些外部库的时候，后面会写一些文章把编译&nbsp;<span style="font-weight:600">FFmpeg</span>&nbsp;与实际项目中运用的姿势做一个分享，欢迎一起交流。我的&nbsp;<span style="font-weight:600">github</span>&nbsp;主页：<a target="_blank" href="https://github.com/mabeijianxi" style="background-color:transparent; color:rgb(3,102,214)"></a><a target="_blank" href="https://github.com/mabeijianxi" style="background-color:transparent; color:rgb(3,102,214)">https://github.com/mabeijianxi</a>，我的csdn主页：<a target="_blank" href="http://blog.csdn.net/mabeijianxi" style="background-color:transparent; color:rgb(3,102,214)"></a><a target="_blank" href="http://blog.csdn.net/mabeijianxi" style="background-color:transparent; color:rgb(3,102,214)">http://blog.csdn.net/mabeijianxi</a>。</p>
<br>
<p><br>
</p>
<p style="margin-top:0px; margin-bottom:16px; color:rgb(36,41,46); font-size:16px">
<br>
</p>
<br>
   
</div>

